<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KRX 데이터 수집 현황</title>
<link rel="stylesheet" href="/dashboard/assets/dashboard.css">
<script src="/dashboard/assets/dashboard.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@5.0.2/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body x-data="dashboard()" x-init="init()" x-cloak>

<header>
  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
  </svg>
  <h1>KRX 데이터 수집 현황</h1>
  <span x-text="'갱신: ' + lastRefresh"></span>
</header>

<nav>
  <template x-for="tab in tabs" :key="tab.id">
    <button :class="{'active': activeTab === tab.id}" @click="switchTab(tab.id)" x-text="tab.label"></button>
  </template>
</nav>

<main>
  <div x-show="activeTab === 'overview'">
    <div class="cards">
      <div class="card">
        <div class="label">종목 수</div>
        <div class="value" x-text="fmt(summary.instrument_count ?? '-')"></div>
      </div>
      <div class="card">
        <div class="label">일별 시세 건수</div>
        <div class="value" x-text="fmt(summary.price_count ?? '-')"></div>
        <div class="sub" x-text="summary.price_date_from ? summary.price_date_from + ' ~ ' + summary.price_date_to : ''"></div>
      </div>
      <div class="card">
        <div class="label">벤치마크 건수</div>
        <div class="value" x-text="fmt(summary.benchmark_count ?? '-')"></div>
        <div class="sub" x-text="summary.benchmark_date_from ? summary.benchmark_date_from + ' ~ ' + summary.benchmark_date_to : ''"></div>
      </div>
      <div class="card">
        <div class="label">거래일 수</div>
        <div class="value" x-text="fmt(summary.trading_days ?? '-')"></div>
      </div>
      <div class="card">
        <div class="label">미해결 이슈</div>
        <div class="value" :style="summary.open_issues > 0 ? 'color:#c53030' : ''" x-text="fmt(summary.open_issues ?? '-')"></div>
      </div>
    </div>

    <div class="section">
      <h2>최근 수집 이력</h2>
      <div x-show="runsLoading" class="loading">로딩 중...</div>
      <div x-show="!runsLoading && runs.length === 0" class="empty">수집 이력이 없습니다</div>
      <table x-show="!runsLoading && runs.length > 0">
        <thead>
          <tr>
            <th>파이프라인</th><th>소스</th><th>기간</th><th>상태</th>
            <th>시작시각</th><th>소요(초)</th><th>성공</th><th>실패</th><th>경고</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="r in runs" :key="r.run_id">
            <tr>
              <td x-text="r.pipeline_name"></td>
              <td x-text="r.source_name"></td>
              <td x-text="r.window_start + ' ~ ' + r.window_end"></td>
              <td><span :class="statusBadge(r.status)" x-text="r.status"></span></td>
              <td x-text="r.started_at ? r.started_at.slice(0,19) : ''"></td>
              <td x-text="elapsed(r.started_at, r.finished_at)"></td>
              <td x-text="r.success_count"></td>
              <td x-text="r.failure_count"></td>
              <td x-text="r.warning_count"></td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
  </div>

  <div x-show="activeTab === 'instruments'">
    <div class="section">
      <h2>종목 선택</h2>
      <div class="controls">
        <input x-model="instrumentQuery" @keyup.enter="searchInstrumentOptions()" placeholder="종목코드 또는 종목명 검색" style="width:300px">
        <button @click="searchInstrumentOptions()">검색</button>
        <input type="date" x-model="priceFrom">
        <input type="date" x-model="priceTo">
        <button @click="reloadSelectedInstrument()" :disabled="!selectedInstrument">조회</button>
      </div>
      <div class="controls">
        <button @click="applyRecentMonths(6)" style="background:#4a5568">최근 6개월</button>
        <button @click="applyRecentMonths(12)" style="background:#4a5568">최근 1년</button>
      </div>
      <div x-show="optionLoading" class="loading">종목 검색 중...</div>
      <div x-show="!optionLoading && instrumentOptions.length === 0" class="empty">검색된 종목이 없습니다</div>
      <div class="picker-list" x-show="!optionLoading && instrumentOptions.length > 0">
        <template x-for="opt in instrumentOptions" :key="opt.market_code + ':' + opt.external_code">
          <button class="picker-item"
                  :class="selectedInstrument && selectedInstrument.market_code === opt.market_code && selectedInstrument.external_code === opt.external_code ? 'selected' : ''"
                  @click="selectInstrument(opt)">
            <span class="picker-code" x-text="opt.external_code"></span>
            <span x-text="opt.instrument_name"></span>
            <span class="picker-market" x-text="opt.market_code"></span>
          </button>
        </template>
      </div>
    </div>

    <div class="section" x-show="selectedInstrument">
      <h2>기본정보</h2>
      <div class="profile-grid">
        <div class="card compact"><div class="label">코드</div><div class="value small" x-text="instrumentProfile?.external_code ?? selectedInstrument?.external_code"></div></div>
        <div class="card compact"><div class="label">종목명</div><div class="value small" x-text="instrumentProfile?.instrument_name ?? selectedInstrument?.instrument_name"></div></div>
        <div class="card compact"><div class="label">시장</div><div class="value small" x-text="instrumentProfile?.market_code ?? selectedInstrument?.market_code"></div></div>
        <div class="card compact"><div class="label">상장상태</div><div class="value small" x-text="instrumentProfile?.listed_status === 'delisted' ? '상장폐지' : '상장'"></div></div>
        <div class="card compact"><div class="label">그룹</div><div class="value small" x-text="instrumentProfile?.security_group ?? '-'"></div></div>
        <div class="card compact"><div class="label">섹터</div><div class="value small" x-text="instrumentProfile?.sector_name ?? '-'"></div></div>
        <div class="card compact"><div class="label">상장일</div><div class="value small" x-text="instrumentProfile?.listing_date ?? '-'"></div></div>
        <div class="card compact"><div class="label">상폐일</div><div class="value small" x-text="instrumentProfile?.delisting_date ?? '-'"></div></div>
      </div>
    </div>

    <div class="section" x-show="selectedInstrument">
      <h2>일별 캔들 차트</h2>
      <div class="ma-panel">
        <div class="ma-group">
          <div class="ma-label">가격 MA</div>
          <div class="ma-controls">
            <button class="ghost-btn" @click="addPriceMA(5)">+5</button>
            <button class="ghost-btn" @click="addPriceMA(20)">+20</button>
            <input type="number" min="2" max="240" x-model="priceMAInput" placeholder="기간(2~240)">
            <button @click="addPriceMAInput()">추가</button>
          </div>
          <div class="ma-chips">
            <template x-for="period in priceMAPeriods" :key="'price-ma-' + period">
              <button class="ma-chip" @click="removePriceMA(period)">
                <span x-text="'SMA ' + period"></span>
                <strong>×</strong>
              </button>
            </template>
          </div>
        </div>
        <div class="ma-group">
          <div class="ma-label">거래량 MA</div>
          <div class="ma-controls">
            <button class="ghost-btn" @click="addVolumeMA(5)">+5</button>
            <button class="ghost-btn" @click="addVolumeMA(20)">+20</button>
            <input type="number" min="2" max="240" x-model="volumeMAInput" placeholder="기간(2~240)">
            <button @click="addVolumeMAInput()">추가</button>
          </div>
          <div class="ma-chips">
            <template x-for="period in volumeMAPeriods" :key="'volume-ma-' + period">
              <button class="ma-chip" @click="removeVolumeMA(period)">
                <span x-text="'SMA ' + period"></span>
                <strong>×</strong>
              </button>
            </template>
          </div>
        </div>
        <div class="ma-error" x-show="maSettingsError" x-text="maSettingsError"></div>
      </div>
      <div x-show="priceLoading" class="loading">로딩 중...</div>
      <div x-show="!priceLoading && prices.length === 0 && priceQueried" class="empty">데이터가 없습니다</div>
      <div x-show="prices.length > 0">
        <div class="chart-wrap">
          <div id="priceChart" class="lw-chart"></div>
        </div>
        <div class="empty" x-show="priceChartError" x-text="priceChartError"></div>
      </div>
    </div>

    <div class="section" x-show="selectedInstrument">
      <h2>벤치마크 일별 캔들</h2>
      <div class="inline-check-row">
        <label class="inline-check">
          <input type="checkbox" x-model="showInstrumentBench" @change="onInstrumentBenchmarkToggle()">
          <span>벤치마크 캔들 표시</span>
        </label>
        <span class="inline-meta" x-show="showInstrumentBench && instrumentBenchIndexCode && instrumentBenchSeriesName"
              x-text="instrumentBenchIndexCode + ' / ' + instrumentBenchSeriesName"></span>
      </div>
      <div class="controls" x-show="showInstrumentBench">
        <select x-model="instrumentBenchIndexCode" @change="onInstrumentBenchmarkIndexChange()">
          <template x-for="b in benchmarks" :key="'inst-bench-index-' + b.index_code">
            <option :value="b.index_code" x-text="b.index_code"></option>
          </template>
        </select>
        <select x-model="instrumentBenchSeriesName" @change="onInstrumentBenchmarkSeriesChange()" :disabled="instrumentBenchSeriesOptions.length === 0">
          <template x-for="s in instrumentBenchSeriesOptions" :key="'inst-bench-series-' + s.index_name">
            <option :value="s.index_name" x-text="s.index_name + ' (' + fmt(s.record_count) + '건)'"></option>
          </template>
        </select>
        <button @click="loadInstrumentBenchmark()" :disabled="!instrumentBenchIndexCode || !instrumentBenchSeriesName">조회</button>
      </div>
      <div x-show="showInstrumentBench && instrumentBenchLoading" class="loading">로딩 중...</div>
      <div x-show="showInstrumentBench && instrumentBenchError" class="empty" x-text="instrumentBenchError"></div>
      <div x-show="showInstrumentBench && !instrumentBenchLoading && !instrumentBenchError && instrumentBenchSeries.length === 0 && instrumentBenchQueried" class="empty">
        조회된 데이터가 없습니다
      </div>
      <div x-show="showInstrumentBench && instrumentBenchSeries.length > 0">
        <div class="chart-wrap">
          <div id="instrumentBenchChart" class="lw-chart"></div>
        </div>
      </div>
    </div>

    <div class="section" x-show="selectedInstrument">
      <h2>일별 시세</h2>
      <table x-show="prices.length > 0">
        <thead>
          <tr><th>일자</th><th>시가</th><th>고가</th><th>저가</th><th>종가</th><th>거래량</th><th>등락률(%)</th><th>상태</th></tr>
        </thead>
        <tbody>
          <template x-for="p in prices" :key="p.trade_date">
            <tr>
              <td x-text="p.trade_date"></td>
              <td x-text="fmt(p.open)"></td>
              <td x-text="fmt(p.high)"></td>
              <td x-text="fmt(p.low)"></td>
              <td x-text="fmt(p.close)"></td>
              <td x-text="fmt(p.volume)"></td>
              <td x-text="p.change_rate != null ? p.change_rate.toFixed(2) : '-'"></td>
              <td x-text="p.record_status"></td>
            </tr>
          </template>
        </tbody>
      </table>
      <div x-show="prices.length === 0 && priceQueried" class="empty">표시할 시세 데이터가 없습니다</div>
    </div>
  </div>

  <div x-show="activeTab === 'quality'">
    <div class="section">
      <h2>데이터 이슈 현황 (미해결)</h2>
      <div class="controls">
        <select x-model="qualitySeverity" @change="loadQualityIssues()">
          <option value="">전체 등급</option>
          <option value="ERROR">ERROR</option>
          <option value="WARN">WARN</option>
          <option value="INFO">INFO</option>
        </select>
      </div>
      <div x-show="qualityLoading" class="loading">로딩 중...</div>
      <div x-show="!qualityLoading && qualityIssues.length === 0" class="empty">미해결 이슈가 없습니다</div>
      <table x-show="!qualityLoading && qualityIssues.length > 0">
        <thead>
          <tr><th>등급</th><th>데이터셋</th><th>일자</th><th>종목/지수</th><th>이슈코드</th><th>상세</th><th>감지시각</th></tr>
        </thead>
        <tbody>
          <template x-for="q in qualityIssues" :key="q.issue_id">
            <tr>
              <td><span :class="severityBadge(q.severity)" x-text="q.severity"></span></td>
              <td x-text="q.dataset_name"></td>
              <td x-text="q.trade_date ?? '-'"></td>
              <td x-text="q.external_code ?? q.index_code ?? '-'"></td>
              <td x-text="q.issue_code"></td>
              <td x-text="q.issue_detail ?? '-'" style="max-width:300px;word-break:break-word"></td>
              <td x-text="q.detected_at ? q.detected_at.slice(0,19) : ''"></td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
  </div>
</main>

</body>
</html>
